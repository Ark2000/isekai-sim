# Project GENESIS - 异世界模拟器

一个基于 WebGL2 的实时星球气候与水文模拟系统。

## 🌟 项目概述

Project GENESIS 是一个运行在浏览器中的交互式星球模拟器，能够模拟地形、气候、水循环等复杂的自然系统。用户可以通过笔刷工具自由编辑地形和气候参数，实时观察自然现象的演化。

---

## ✨ 已实现功能

### 1. 地形系统
- ✅ **程序化生成**：使用 Simplex Noise + FBM 生成自然地形
- ✅ **实时编辑**：圆形笔刷工具，支持绘制/擦除地形
- ✅ **立体渲染**：Hillshade 光照效果，增强地形立体感
- ✅ **目标值模式**：笔刷可以限制高度上下限，方便绘制平原和海洋

### 2. 大气系统
- ✅ **风场模拟**
  - 全局风向控制
  - 地形阻挡效应（山脉会阻挡风）
  - **温差驱动风**（热力风效应：热源周围产生环流）
  - 随机扰动（自然的风场变化）

- ✅ **温度系统**
  - 纬度-温度梯度（赤道热，两极冷）
  - 海拔-温度负相关（山顶更冷）
  - **温度平流**：热空气随风流动
  - **热扩散**：热量向周围传导
  - 可编辑：用笔刷绘制"火炉"或"冰川"

- ✅ **云层系统**
  - 水汽→云→降雨完整循环
  - **云随风飘动**（平流传输）
  - 地形抬升凝结（迎风坡多雨）
  - 温度影响凝结速度
  - 云层可视化：半透明叠加 + 阴影投影

### 3. 水文系统
- ✅ **水流模拟**
  - 基于高度差的重力流动
  - 水量守恒算法
  - 水深可视化（深浅蓝色渐变）

- ✅ **完整水循环**
  - 🌊 **蒸发**：海洋、湖泊蒸发产生水汽（温度越高越快）
  - 💨 **水汽输送**：水汽随风飘动
  - ☁️ **凝结成云**：水汽在冷空气或山坡上凝结
  - 🌧️ **降雨**：云太厚会下雨，形成地面水
  - 🌊 **径流**：雨水汇聚成河流、湖泊
  - 🔄 循环往复

### 4. 交互系统
- ✅ **多功能笔刷**
  - 可编辑：地形、温度、云层、水
  - 可调参数：强度、半径、随机扰动
  - 支持加法（左键）和减法（右键）模式

- ✅ **视图系统**
  - 独立的可见性开关（可叠加显示多层）
    - Show Terrain（地形）
    - Show Hillshade（阴影）
    - Show Water（水）
    - Show Temp（温度热力图）
    - Show Cloud（云层）
    - Show Wind（风场矢量图）
  - 缩放 & 平移（鼠标滚轮 + 中键拖拽）

- ✅ **GUI 控制面板**
  - 工具选择：选择笔刷目标
  - 笔刷参数：强度、半径、扰动、限制模式
  - 环境参数：全局风速
  - 物理参数：
    - 云物理（消散、降雨阈值、蒸发、凝结）
    - 温度物理（扩散、惯性、热力风）
    - 水物理（流速、蒸发）
  - 生成器：一键生成地形

### 5. 渲染系统
- ✅ **WebGL2 + MRT**：4 个 RGBA32F 纹理（16 通道数据）
- ✅ **Ping-Pong 渲染**：实时物理模拟
- ✅ **Uber Shader**：统一的物理模拟核心
- ✅ **模块化代码**：分离的 JS 模块和 GLSL Shader 文件
- ✅ **循环边界**：纹理采样支持环绕（类似环面拓扑）

---

## 🚧 已知不足

### 1. 河流效果不理想
- **问题**：水流动时会扩散成水洼，无法形成细长的河道
- **原因**：
  - 扩散算法导致水均匀向四周铺开
  - 256×256 分辨率对河流太粗糙
  - 缺少流速/动量记忆
- **可能方案**：
  - 侵蚀系统：让水冲刷地形，自动形成河道
  - 流向场预计算：GIS 风格的汇水分析
  - 提高分辨率（512×512 或更高）

### 2. 地形生成器边界不连续
- **问题**：生成的地形在边界处可能有接缝
- **影响**：有限（物理模拟本身是循环的，且用户可以编辑）
- **可能方案**：实现真正的环面噪声（但可能损失质量）

### 3. 性能优化空间
- **当前**：60 FPS @ 256×256
- **潜在优化**：
  - 降低不必要的 Uniform 传递
  - 合并部分计算步骤
  - 支持可变分辨率

### 4. 缺少持久化
- **问题**：刷新页面会丢失所有数据
- **需求**：保存/加载地图状态

### 5. 笔刷边界循环不完美
- **问题**：虽然实现了距离计算的环绕，但在边界绘制时可能有细微偏差
- **影响**：很小

---

## 🎯 未来计划

### 短期目标（已规划）

#### 1. 侵蚀系统
- 水力侵蚀：流动的水慢慢挖低地形
- 热侵蚀：山坡自然坍塌（模拟风化）
- 效果：长时间运行后自动形成河谷、峡谷

#### 2. 植被系统
- 新数据层：植被覆盖率
- 生长条件：温度 + 水分
- 可视化：绿色渐变覆盖
- 影响：改变蒸发速率、地表反照率

#### 3. 季节系统
- 时间轴控制
- 太阳倾角变化
- 季节性温度/降雨变化
- 冰雪覆盖（冬季）

#### 4. 改进的河流系统
- 方案 A：侵蚀 + 时间
- 方案 B：预计算流向场，直接可视化河网
- 方案 C：提高分辨率 + 更好的流动算法

### 中期目标（探索中）

#### 5. 生物圈
- 简单的生命模拟（类似 Game of Life）
- 种群密度分布
- 食物链关系
- 受环境影响（温度、水、植被）

#### 6. 文明模拟
- 聚落系统：村庄→城市
- 资源需求：水源、平原、气候
- 贸易路线：沿河流/海岸
- 人类对环境的影响

#### 7. 地质系统
- 板块运动（极长时间尺度）
- 火山活动
- 地震

### 长期愿景

#### 8. 多星球系统
- 太阳系模拟
- 行星轨道
- 潮汐效应

#### 9. 3D 视角
- 从 2D Top-Down 转为 3D 球体
- 真实的球面投影
- 相机旋转/缩放

#### 10. 性能突破
- WebGPU 迁移（更高性能）
- 支持 4K 分辨率模拟
- 多 GPU 并行

---

## 🛠️ 技术栈

- **语言**：JavaScript (ES6 Modules) + GLSL 3.0
- **图形**：WebGL 2.0
- **GUI**：Tweakpane 4.0
- **架构**：
  - MRT (Multiple Render Targets)
  - Ping-Pong Rendering
  - GPGPU (通用 GPU 计算)

---

## 📊 数据结构

### 纹理通道分配

| 纹理 | R | G | B | A |
|------|---|---|---|---|
| **Tex0** | 地形高度 | - | - | - |
| **Tex1** | 温度 | - | - | - |
| **Tex2** | 风 X | 风 Y | 云密度 | 水汽 |
| **Tex3** | 水深 | - | - | - |

> 共 16 个通道，RGBA32F 浮点精度

---

## 🎮 使用说明

### 基本操作
- **左键拖拽**：绘制（增加值）
- **右键拖拽**：擦除（减少值）
- **鼠标滚轮**：缩放
- **中键拖拽** 或 **空格+左键**：平移画布

### 推荐实验

#### 实验 1：观察水循环
1. 生成地形（Generate Terrain）
2. 调高蒸发速率（Evaporation = 0.02）
3. 设置风向（Wind X = 1.0）
4. 观察：海洋→云→山脉降雨→河流→回海

#### 实验 2：绘制火炉
1. 选择工具：Edit Temperature
2. 在陆地中心画一个高温区
3. 开启 Show Wind 和 Show Cloud
4. 观察：热源产生上升气流 + 环流 + 局地降雨

#### 实验 3：大洪水
1. 选择工具：Edit Water
2. 在山顶画水
3. 观察：水顺山坡流下，汇聚成湖

#### 实验 4：冰川世界
1. Edit Temperature，右键把全球降温
2. Cloud Decay 调到 0.99（云消散加快）
3. 观察：干冷世界，云稀少

---

## 📁 项目结构

```
ProjectGENESIS/
├── src/
│   ├── index.html          # 入口页面
│   ├── main.js            # 启动入口
│   ├── config.js          # 全局常量
│   ├── utils.js           # 工具函数
│   ├── GLUtils.js         # WebGL 辅助
│   ├── shaders.js         # GLSL Shader 代码
│   ├── Layer.js           # 图层基类
│   ├── WorldLayer.js      # 核心物理模拟层
│   ├── CircleBrush.js     # 笔刷工具
│   ├── TerrainEditor.js   # 主编辑器
│   └── SimulationPlayer.js # 播放控制（未使用）
└── README.md              # 本文档
```

---

## 🌐 运行方法

### 本地服务器
```bash
# 使用 Python
python -m http.server 8000

# 使用 Node.js (http-server)
npx http-server

# 使用 VS Code Live Server 插件
```

访问 `http://localhost:8000/src/index.html`

### 注意事项
- ⚠️ **必须通过 HTTP 服务器运行**（ES Modules 不支持 `file://`）
- ⚠️ **需要支持 WebGL 2.0 的浏览器**（Chrome/Edge/Firefox 推荐）

---

## 📝 开发日志

### Version 0.1 - 核心架构
- 实现 WebGL2 + MRT + Ping-Pong
- 基础地形编辑

### Version 0.2 - 气候系统
- 温度场
- 风场（温差驱动）
- 云层模拟

### Version 0.3 - 水循环（当前版本）
- 水流模拟
- 完整水循环（蒸发-云-降雨-径流）
- 循环边界支持

---

## 🙏 致谢

- **Simplex Noise** by Stefan Gustavson
- **Tweakpane** GUI Library
- 灵感来源：Dwarf Fortress, Minecraft, WorldBox

---

## 📜 许可证

MIT License (待定)

---

**Project GENESIS** - 创造属于你的世界 🌍✨

